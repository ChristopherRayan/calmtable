{# Admin dashboard with stable-height analytics cards and recent activity feed. #}
{% extends "admin/index.html" %}
{% load i18n %}

{% block content %}
<div class="row mb-4">
  {% for card in dashboard_cards|slice:":4" %}
    <div class="col-lg-3 col-md-6 col-12 mb-3">
      <div class="card card-warning card-outline h-100">
        <div class="card-body">
          <p class="text-uppercase text-muted mb-1" style="letter-spacing:.1em;font-size:11px">{{ card.label }}</p>
          <h3 class="mb-0">{{ card.value }}</h3>
        </div>
      </div>
    </div>
  {% endfor %}
</div>

<div class="row mt-2">
  <div class="col-md-8">
    <div class="card card-warning card-outline">
      <div class="card-header">
        <h3 class="card-title">Orders Per Day (Last 30 Days)</h3>
      </div>
      <div class="card-body">
        <div style="position:relative;height:280px;width:100%;">
          <canvas id="ordersChart"></canvas>
        </div>
      </div>
    </div>
  </div>

  <div class="col-md-4">
    <div class="card card-warning card-outline">
      <div class="card-header">
        <h3 class="card-title">Revenue (MK)</h3>
      </div>
      <div class="card-body">
        <div style="position:relative;height:280px;width:100%;">
          <canvas id="revenueChart"></canvas>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="row mt-3">
  <div class="col-12">
    <div class="card card-warning card-outline">
      <div class="card-header">
        <h3 class="card-title">Recent Activity</h3>
      </div>
      <div class="card-body p-0">
        <table class="table table-hover mb-0">
          <thead>
            <tr>
              <th>Code</th>
              <th>Name</th>
              <th>Email</th>
              <th>Date</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody>
            {% for row in recent_activity %}
              <tr>
                <td>{{ row.confirmation_code }}</td>
                <td>{{ row.name }}</td>
                <td>{{ row.email }}</td>
                <td>{{ row.date }} {{ row.time_slot }}</td>
                <td>{{ row.status|title }}</td>
              </tr>
            {% empty %}
              <tr>
                <td colspan="5" class="text-center py-4 text-muted">No recent activity.</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

{{ block.super }}

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
  (function () {
    function buildOrdersChart(payload) {
      var node = document.getElementById('ordersChart');
      if (!node) return;
      var ctx = node.getContext('2d');
      new Chart(ctx, {
        type: 'bar',
        data: {
          labels: payload.labels || [],
          datasets: [{
            label: 'Orders',
            data: payload.values || [],
            backgroundColor: 'rgba(210,180,140,0.6)',
            borderColor: '#D2B48C',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: { y: { beginAtZero: true, ticks: { precision: 0 } } }
        }
      });
    }

    function buildRevenueChart(payload) {
      var node = document.getElementById('revenueChart');
      if (!node) return;
      var ctx = node.getContext('2d');
      new Chart(ctx, {
        type: 'line',
        data: {
          labels: payload.labels || [],
          datasets: [{
            label: 'Revenue (MK)',
            data: payload.values || [],
            fill: true,
            backgroundColor: 'rgba(92,64,51,0.15)',
            borderColor: '#5C4033',
            tension: 0.4,
            pointBackgroundColor: '#D2B48C'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: { y: { beginAtZero: true } }
        }
      });
    }

    fetch('/api/analytics/orders-per-day/')
      .then(function (res) { return res.ok ? res.json() : { labels: [], values: [] }; })
      .then(buildOrdersChart)
      .catch(function () {});

    fetch('/api/analytics/revenue/')
      .then(function (res) { return res.ok ? res.json() : { labels: [], values: [] }; })
      .then(buildRevenueChart)
      .catch(function () {});
  })();
</script>
{% endblock %}
